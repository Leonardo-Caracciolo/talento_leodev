$(document).ready(function () {
  console.log("Hola desde Pais");

  // Define the HTML content for Pais
  const paisContent = `
    <div class="flex flex-col gap-4">
      <!-- Filtros Card -->
      <div class="bg-white shadow-md rounded-lg p-6">
        <h2 class="text-xl font-semibold mb-4">Filtros</h2>
        <div class="mb-4">
          <label for="valueSliderEmpleados" class="block text-gray-700">Cantidad de empleados mensual:</label>
          <input type="range" id="valueSliderEmpleados" class="w-full" />
          <span id="sliderValueEmpleados" class="block text-gray-700 mt-2"></span>
        </div>
        <div class="mb-4">
          <label for="valueSliderRegistros" class="block text-gray-700">Cantidad de registros mensual:</label>
          <input type="range" id="valueSliderRegistros" class="w-full" />
          <span id="sliderValueRegistros" class="block text-gray-700 mt-2"></span>
        </div>
        <div class="mb-4">
          <label for="monthSelect" class="block text-gray-700">Mes:</label>
          <select id="monthSelect" class="w-full border border-gray-300 rounded-lg p-2">
            <option value="all">Todos</option>
          </select>
        </div>
        <div class="mb-4">
          <label for="countrySelect" class="block text-gray-700">Pais:</label>
          <select id="countrySelect" class="w-full border border-gray-300 rounded-lg p-2">
            <option value="all">Todos</option>
          </select>
        </div>
        <button id="sendEmailButton" class="bg-blue-500 text-white px-4 py-2 rounded mt-4 w-full">Send Email</button>
      </div>

      <!-- Tabla Card -->
      <div class="bg-white shadow-md rounded-lg p-6">
        <h2 class="text-xl font-semibold mb-4">Datos</h2>
        <table id="dataTable" class="min-w-full bg-white">
          <!-- Table content will be generated by JavaScript -->
        </table>
      </div>
    </div>
  `;

  // Inject the HTML content into the #pais-content container
  $("#pais-content").html(paisContent);

  // Pais related scripts
  function fetchDataFrame(endpoint) {
    $.getJSON(endpoint, function (data) {
      // Calculate min and max values for sliders
      const minEmpleados = Math.min(
        ...data.map((row) => row.Cantidad_Empleados)
      );
      const maxEmpleados = Math.max(
        ...data.map((row) => row.Cantidad_Empleados)
      );
      const minRegistros = Math.min(
        ...data.map((row) => row.Cantidad_Registros)
      );
      const maxRegistros = Math.max(
        ...data.map((row) => row.Cantidad_Registros)
      );
      const uniqueMonths = [...new Set(data.map((row) => row.Mes))].sort(
        (a, b) => a - b
      );
      const uniqueCountries = [...new Set(data.map((row) => row.Pais))];

      // Set slider attributes
      $("#valueSliderEmpleados").attr("min", minEmpleados);
      $("#valueSliderEmpleados").attr("max", maxEmpleados);
      $("#valueSliderEmpleados").val(minEmpleados);
      $("#sliderValueEmpleados").text(minEmpleados);

      $("#valueSliderRegistros").attr("min", minRegistros);
      $("#valueSliderRegistros").attr("max", maxRegistros);
      $("#valueSliderRegistros").val(minRegistros);
      $("#sliderValueRegistros").text(minRegistros);

      // Populate month select options
      let monthOptions = '<option value="all">All</option>';
      uniqueMonths.forEach((month) => {
        monthOptions += `<option value="${month}">${month}</option>`;
      });
      $("#monthSelect").html(monthOptions);
      
      // Populate country select options
      let countryOptions = '<option value="all">All</option>';
      uniqueCountries.forEach((country) => {
        countryOptions += `<option value="${country}">${country}</option>`;
      });
      $("#countrySelect").html(countryOptions);

      // Generate table with data
      generateTable(data);
    });
  }

  // Function to generate table
  function generateTable(data) {
    let tableContent = `
      <thead>
        <tr>
          <th class="px-4 py-2">Mes</th>
          <th class="px-4 py-2">Pais</th>
          <th class="px-4 py-2">Cantidad Empleados</th>
          <th class="px-4 py-2">Cantidad Registros</th>
          <th class="px-4 py-2">Email</th>
        </tr>
      </thead>
      <tbody>
    `;
    data.forEach((row) => {
      tableContent += `
        <tr>
          <td class="border px-4 py-2">${row.Mes}</td>
          <td class="border px-4 py-2">${row.Pais}</td>
          <td class="border px-4 py-2">${row.Cantidad_Empleados}</td>
          <td class="border px-4 py-2">${row.Cantidad_Registros}</td>
          <td class="border px-4 py-2">${row.email}</td>
        </tr>
      `;
    });
    tableContent += "</tbody>";
    $("#dataTable").html(tableContent);
  }

  // Initial table generation
  fetchDataFrame("/aggregated_pais_data/");

  // Update slider value display
  $("#valueSliderEmpleados").on("input", function () {
    $("#sliderValueEmpleados").text($(this).val());
  });

  $("#valueSliderRegistros").on("input", function () {
    $("#sliderValueRegistros").text($(this).val());
  });

  // Filter table based on slider values and selected month
  function filterTable() {
    const filterValueEmpleados = $("#valueSliderEmpleados").val();
    const filterValueRegistros = $("#valueSliderRegistros").val();
    const selectedMonth = $("#monthSelect").val();
    const selectedCountry = $("#countrySelect").val();
    $.getJSON("/aggregated_pais_data/", function (data) {
      const filteredData = data.filter(
        (row) =>
          row.Cantidad_Empleados >= filterValueEmpleados &&
          row.Cantidad_Registros >= filterValueRegistros &&
          (selectedMonth === "all" || row.Mes == selectedMonth) &&
          (selectedCountry === "all" || row.Pais == selectedCountry)
      );
      generateTable(filteredData);
    });
  }

  $("#valueSliderEmpleados").on("change", filterTable);
  $("#valueSliderRegistros").on("change", filterTable);
  $("#monthSelect").on("change", filterTable);
  $("#countrySelect").on("change", filterTable);

  // Send email function
  $("#sendEmailButton").on("click", function () {
    const sliderValueEmpleados = $("#valueSliderEmpleados").val();
    const sliderValueRegistros = $("#valueSliderRegistros").val();
    const selectedMonth = $("#monthSelect").val();
    const selectedCountry = $("#countrySelect").val();

    // Show loading spinner
    $("#loadingSpinner").removeClass("hidden");

    $.post(
      "/send_email_pais",
      {
        slider_value_empleados: sliderValueEmpleados,
        slider_value_registros: sliderValueRegistros,
        selected_month: selectedMonth,
        selected_country: selectedCountry,
      },
      function (response) {
        alert(response.message);
        // Hide loading spinner
        $("#loadingSpinner").addClass("hidden");
      }
    ).fail(function () {
      alert("Error sending email.");
      // Hide loading spinner
      $("#loadingSpinner").addClass("hidden");
    });
  });
});
